name: Rust

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Continue with other OS builds even if one fails
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      # Install Linux dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libglib2.0-dev \
            pkg-config \
            build-essential \
            libssl-dev \
            libappindicator3-dev

      # Set up cache
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Collect environment information for debugging
      - name: Collect environment info
        run: |
          mkdir -p logs
          echo "OS: ${{ runner.os }}" > logs/env-info.txt
          echo "Rust version:" >> logs/env-info.txt
          rustc --version >> logs/env-info.txt
          echo "Cargo version:" >> logs/env-info.txt
          cargo --version >> logs/env-info.txt
          echo "Dependencies:" >> logs/env-info.txt
          if [ "${{ runner.os }}" = "Linux" ]; then
            dpkg -l | grep -E 'webkit|gtk|glib' >> logs/env-info.txt
          elif [ "${{ runner.os }}" = "macOS" ]; then
            brew list >> logs/env-info.txt
          fi

      # Build the project
      - name: Build
        working-directory: src-tauri
        run: cargo build --verbose 2>&1 | tee ../logs/build-log.txt

      # Run tests
      - name: Run tests
        working-directory: src-tauri
        run: cargo test --verbose 2>&1 | tee ../logs/test-log.txt
        continue-on-error: true # Continue to save logs even if tests fail

      # Collect detailed dependency information
      - name: Collect dependency info
        working-directory: src-tauri
        run: cargo tree > ../logs/cargo-tree.txt
        continue-on-error: true # Continue workflow even if this step fails

      # Save logs as artifacts
      - name: Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ runner.os }}
          path: logs/
          retention-days: 7
