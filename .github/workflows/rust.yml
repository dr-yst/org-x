name: Rust

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # Continue with other OS builds even if one fails
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      # Install Linux dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo add-apt-repository universe
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libglib2.0-dev \
            pkg-config \
            build-essential \
            libssl-dev \
            libappindicator3-dev

      # Set up cache
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # Build the project
      - name: Build
        id: build
        working-directory: src-tauri
        run: cargo build --verbose

      # Run tests
      - name: Run tests
        id: tests
        if: success() # Only run if build succeeded
        working-directory: src-tauri
        run: cargo test --verbose

      # Upload artifacts only on failure
      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-${{ runner.os }}
          path: |
            src-tauri/target/debug/deps/*
            src-tauri/Cargo.lock
            src-tauri/Cargo.toml
          retention-days: 3

      # Collect dependency info on failure
      - name: Collect dependency info on failure
        if: failure()
        working-directory: src-tauri
        run: |
          mkdir -p ../logs
          cargo tree > ../logs/cargo-tree.txt
          echo "OS: ${{ runner.os }}" > ../logs/env-info.txt
          rustc --version >> ../logs/env-info.txt
          cargo --version >> ../logs/env-info.txt
          if [ "${{ runner.os }}" = "Linux" ]; then
            dpkg -l | grep -E 'webkit|gtk|glib' >> ../logs/env-info.txt
          fi

      # Upload debug logs on failure
      - name: Upload debug logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ runner.os }}
          path: logs/
          retention-days: 3
